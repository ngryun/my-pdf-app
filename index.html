<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF 영어 문장 추출기 (Gemini 적용)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- PDF.js 라이브러리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        // PDF.js가 백그라운드에서 작동하는 데 필요한 worker 스크립트 경로를 설정합니다.
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        /* 결과 영역의 스타일을 지정합니다. */
        #result-container p {
            margin-bottom: 0.75rem; /* 각 문장 아래에 여백 추가 */
            line-height: 1.6;     /* 줄 간격 조절 */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- 메인 컨테이너 -->
    <div class="w-full max-w-2xl p-8 space-y-6 bg-white rounded-xl shadow-lg">
        
        <!-- 헤더 -->
        <div class="text-center">
            <h1 class="text-3xl font-bold text-gray-900">PDF 영어 문장 추출기 (Gemini 적용)</h1>
            <p class="mt-2 text-sm text-gray-600">PDF를 업로드하면 AI가 완전한 영어 문장만 추출합니다.</p>
        </div>
        
        <!-- 파일 업로드 폼 -->
        <div class="space-y-4">
            <div>
                <label for="pdf-upload" class="sr-only">PDF 파일 업로드</label>
                <input id="pdf-upload" name="pdf" type="file" accept=".pdf" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 transition">
            </div>
            <button id="extract-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition disabled:bg-indigo-300">
                <svg id="btn-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M4 22h14a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v4"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M2.5 17a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1Z"></path><path d="M6.5 17a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1Z"></path><path d="M10.5 17a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1Z"></path></svg>
                <span id="btn-text">문장 추출하기</span>
            </button>
        </div>
        
        <!-- 결과 표시 영역 -->
        <div class="mt-6 p-6 border border-gray-200 rounded-lg bg-gray-50 min-h-[200px]">
             <div id="status-container" class="flex items-center justify-center h-full">
                 <div id="loader" class="hidden animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                 <p id="status-text" class="text-gray-600 text-center">추출된 문장이 여기에 표시됩니다.</p>
            </div>
            <div id="result-container" class="text-left text-gray-800"></div>
        </div>
    </div>

    <script type="module">
        // Gemini API 라이브러리를 가져옵니다.
        import { GoogleGenerativeAI } from "https://cdn.jsdelivr.net/npm/@google/generative-ai/+esm";

        // HTML 요소들을 변수에 할당합니다.
        const extractBtn = document.getElementById('extract-btn');
        const pdfUpload = document.getElementById('pdf-upload');
        const statusContainer = document.getElementById('status-container');
        const resultContainer = document.getElementById('result-container');
        const loader = document.getElementById('loader');
        const statusText = document.getElementById('status-text');
        const btnText = document.getElementById('btn-text');
        
        // Gemini API 설정
        //const API_KEY = 'AIzaSyCPICyoOYYxTLZJiXhkh-W6J_CGA_Vumn4';
        //const genAI = new GoogleGenerativeAI(API_KEY);
        //const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

        // '문장 추출하기' 버튼 클릭 이벤트 리스너
        extractBtn.addEventListener('click', async () => {
            const file = pdfUpload.files[0];
            if (!file) {
                statusText.textContent = '먼저 PDF 파일을 선택해주세요.';
                return;
            }

            // UI를 로딩 상태로 변경합니다.
            loader.classList.remove('hidden');
            statusText.textContent = 'PDF 파일을 분석 중입니다...';
            resultContainer.innerHTML = '';
            extractBtn.disabled = true;
            btnText.textContent = '추출 중...';
            
            try {
                const fileReader = new FileReader();
                
                fileReader.onload = async (event) => {
                    try {
                        const typedarray = new Uint8Array(event.target.result);
                        const pdf = await pdfjsLib.getDocument(typedarray).promise;
                        let allText = '';

                        for (let i = 1; i <= pdf.numPages; i++) {
                            statusText.textContent = `${pdf.numPages} 페이지 중 ${i} 페이지를 읽는 중...`;
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            allText += textContent.items.map(item => item.str).join(' ');
                        }

                        statusText.textContent = '추출된 텍스트를 AI로 분석 중입니다...';

                        // Gemini API에 보낼 프롬프트
                        const prompt = `From the following text, extract only the complete English sentences. List each sentence on a new line. Do not add any numbering, bullet points, or introductory text.\n\n---\n\nTEXT: "${allText}"`;

                        // Gemini API 호출
                        // 서버리스 함수에 POST 요청을 보냅니다.
                        const response = await fetch('/.netlify/functions/getSentences', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ text: allText }), // 추출한 텍스트를 전송
                        });

                        if (!response.ok) {
                            throw new Error('서버리스 함수 호출에 실패했습니다.');
                        }

                        const data = await response.json();
                        const aiResponseText = data.sentences; // 서버리스 함수가 보내준 결과

                        // API 응답을 줄바꿈 기준으로 나누어 문장 배열 생성
                        const englishSentences = aiResponseText.split('\n').filter(s => s.trim() !== '');

                        // 결과를 화면에 표시합니다.
                        if (englishSentences.length > 0) {
                            resultContainer.innerHTML = englishSentences
                                .map((sentence, index) => `<p><strong>문장 ${index + 1}:</strong> ${sentence.trim()}</p>`)
                                .join('');
                            statusText.textContent = `총 ${englishSentences.length}개의 영어 문장을 찾았습니다.`;
                        } else {
                            statusText.textContent = 'AI가 PDF에서 완전한 영어 문장을 찾지 못했습니다.';
                        }

                    } catch (err) {
                        console.error('Processing Error:', err);
                        statusText.textContent = `처리 중 오류가 발생했습니다: ${err.message}`;
                    } finally {
                        // 처리가 끝나면 UI 복원
                        loader.classList.add('hidden');
                        extractBtn.disabled = false;
                        btnText.textContent = '문장 추출하기';
                    }
                };

                fileReader.onerror = () => {
                    throw new Error('파일을 읽는 중 오류가 발생했습니다.');
                };
                
                fileReader.readAsArrayBuffer(file);

            } catch (error) {
                console.error('Error:', error);
                statusText.textContent = `오류가 발생했습니다: ${error.message}`;
                loader.classList.add('hidden');
                extractBtn.disabled = false;
                btnText.textContent = '문장 추출하기';
            }
        });
    </script>
</body>
</html>
